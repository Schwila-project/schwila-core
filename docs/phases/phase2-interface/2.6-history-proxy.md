# 📜 2.6 - وكيل سجل التفاعل (History Proxy)

## 🎯 الهدف
استرجاع مقتطفات من تفاعل سابق للزائر (إن وُجد) من التخزين المؤقت (Redis)، وعرضها بطريقة ذكية تساعده على استكمال تجربته من حيث توقف.

---

## 🧠 الفرضية
إذا كان الزائر معروفًا أو شبه معروف، يمكن للنظام استرجاع آخر نقطة تفاعل له (مثل المرحلة التي توقف عندها، أو القسم الذي زاره)، وعرضها كاقتراح ذكي لاستكمال التفاعل.

---

## 🧩 المدخلات المطلوبة

| المتغير         | المصدر                         |
|------------------|--------------------------------|
| `fingerprint`    | من localStorage                |
| `session_id`     | من sessionStorage              |
| `classification` | من `/identify` (phase1.5)      |

---

## 🧭 منطق الاسترجاع

1. التحقق من أن التصنيف `known` أو `partially_known`
2. البحث في Redis عن `history:{fingerprint}`
3. إذا وُجد سجل سابق:
   - عرض رسالة استئناف ذكية
   - تفعيل زر "استكمال من حيث توقفت"
4. إذا لم يوجد سجل:
   - لا يتم عرض أي شيء

---

## 💡 أمثلة على الرسائل

| الحالة                          | الرسالة المقترحة                          |
|----------------------------------|--------------------------------------------|
| توقف عند المرحلة 2.3             | "👋 مرحبًا مجددًا! توقفت عند 2.3 - هل ترغب في المتابعة؟" |
| زار قسم "التحقق" سابقًا          | "🧪 آخر مرة كنت تستعرض وحدة التحقق — هل نكمل؟" |

---

## 💻 كود مبدئي (client/history-proxy.js)

```js
async function checkHistory(fingerprint) {
  const lastPhase = await fetch(`/api/history/${fingerprint}`).then(r => r.json());

  if (lastPhase?.phase) {
    showResumePrompt(`👋 مرحبًا! توقفت عند ${lastPhase.phase} — هل ترغب في المتابعة؟`);
  }
}
